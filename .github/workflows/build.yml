name: Build and Deploy

on:
    push:
        branches: [main]
    pull_request:
        branches: [main]

permissions:
    contents: write
    pages: write
    id-token: write

concurrency:
    group: "pages"
    cancel-in-progress: false

jobs:
    build:
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v4
              with:
                  fetch-depth: 0
                  token: ${{ secrets.GITHUB_TOKEN }}

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Determine version bump
              id: version
              run: |
                  # Get current version
                  CURRENT_VERSION=$(node -p "require('./package.json').version")
                  echo "Current version: $CURRENT_VERSION"

                  # Parse current version
                  IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT_VERSION"

                  # Get commits since last tag (or all commits if no tags)
                  LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
                  if [ -z "$LAST_TAG" ]; then
                    COMMITS=$(git log --pretty=format:"%s" 2>/dev/null || echo "")
                  else
                    COMMITS=$(git log ${LAST_TAG}..HEAD --pretty=format:"%s" 2>/dev/null || echo "")
                  fi

                  echo "Commits since last tag:"
                  echo "$COMMITS"

                  # Determine bump type from conventional commits
                  BUMP="none"
                  if echo "$COMMITS" | grep -qiE "^feat(\(.+\))?!:|BREAKING CHANGE"; then
                    BUMP="major"
                  elif echo "$COMMITS" | grep -qiE "^feat(\(.+\))?:"; then
                    BUMP="minor"
                  elif echo "$COMMITS" | grep -qiE "^fix(\(.+\))?:"; then
                    BUMP="patch"
                  fi

                  # Calculate new version
                  if [ "$BUMP" = "major" ]; then
                    MAJOR=$((MAJOR + 1))
                    MINOR=0
                    PATCH=0
                  elif [ "$BUMP" = "minor" ]; then
                    MINOR=$((MINOR + 1))
                    PATCH=0
                  elif [ "$BUMP" = "patch" ]; then
                    PATCH=$((PATCH + 1))
                  fi

                  NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
                  echo "New version: $NEW_VERSION (bump: $BUMP)"

                  echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_OUTPUT
                  echo "BUMP=$BUMP" >> $GITHUB_OUTPUT

            - name: Update package.json version
              if: github.event_name == 'push' && steps.version.outputs.BUMP != 'none'
              run: |
                  npm version ${{ steps.version.outputs.NEW_VERSION }} --no-git-tag-version

            - name: Build for GitHub Pages
              env:
                  VITE_BUILD_VERSION: ${{ steps.version.outputs.NEW_VERSION }}
                  BUILD_TARGET: pages
                  VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
                  VITE_SUPABASE_ANON_KEY: ${{ secrets.VITE_SUPABASE_ANON_KEY }}
              run: npm run build:pages

            - name: Commit version bump
              if: github.event_name == 'push' && steps.version.outputs.BUMP != 'none'
              run: |
                  git config user.name "github-actions[bot]"
                  git config user.email "github-actions[bot]@users.noreply.github.com"
                  git add package.json package-lock.json
                  git commit -m "chore: bump version to ${{ steps.version.outputs.NEW_VERSION }} [skip ci]"

                  # Create tag if it doesn't exist, or force update if it does
                  if git rev-parse "v${{ steps.version.outputs.NEW_VERSION }}" >/dev/null 2>&1; then
                    echo "Tag v${{ steps.version.outputs.NEW_VERSION }} already exists, updating it"
                    git tag -f "v${{ steps.version.outputs.NEW_VERSION }}"
                  else
                    git tag "v${{ steps.version.outputs.NEW_VERSION }}"
                  fi

                  git push
                  git push --tags --force

            - name: Setup Pages
              if: github.event_name == 'push'
              uses: actions/configure-pages@v4

            - name: Upload artifact
              if: github.event_name == 'push'
              uses: actions/upload-pages-artifact@v3
              with:
                  path: "./dist"

    deploy:
        if: github.event_name == 'push'
        environment:
            name: github-pages
            url: ${{ steps.deployment.outputs.page_url }}
        runs-on: ubuntu-latest
        needs: build
        steps:
            - name: Deploy to GitHub Pages
              id: deployment
              uses: actions/deploy-pages@v4
